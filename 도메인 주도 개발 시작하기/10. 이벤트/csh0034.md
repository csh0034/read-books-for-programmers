# 10. 이벤트

## 10.1 시스템 간 강결합 문제

주문 도메인에서 환불을 진행하려고 할때 환불 기능을 제공하는     
도메인 서비스를 통해 실행하게 된다.

보통 결제 시스템은 외부에 존재하므로 도메인 서비스에서 외부서비스를 호출한다.

이때 여러 문제가 발생할수 있다.

첫번째로 외부 서비스가 정상이 아닐 경우 트랜잭션 처리를 어떻게 해야하는가?  
환불기능 실행중 예외 발생시 롤백할지 커밋할지 애매하다. 

두번째로 외부 시스템의 응답이 길어질 경우의 성능 문제이다.  
환불 처리 기능이 오래걸릴수록 주문 취소 기능 또한 대기 시간이 증가한다.    
즉, 외부 서비스 성능에 직접적인 영향을 받는다.

추가적인 문제로 설계상 문제가 나타날 수 있다.  
주문을 표현하는 도메인에 결제 도메인의 환불 로직이 뒤섞이게 된다.

지금 까지 언급한 문제가 발생하는 이유는 주문과 결제 바운디드 컨텍스트의  
강결합 때문이다.

이런 강결합은 이벤트를 통해 없앨수 있다.  
특히 비동기 이벤트를 사용하면 두 시스템 간의 결합을 크게 낮출 수 있다.

## 10.2 이벤트 개요

이 절에서 사용하는 이벤트라는 용어는 '과거에 벌어진 어떤 것' 을 뜻한다.   
이벤트가 발생한다는 것은 상태가 변경됐다는 것을 의미한다.

### 10.2.1 이벤트 관련 구성요소

도메인 모델에 이벤트를 도입하려면 아래와 같은 네 개의 구성요소를 구현해야한다.

- 이벤트
- 이벤트 생성 주체
- 이벤트 디스패처(퍼블리셔)
- 이벤트 핸들러(구독자)

![01.png](img/01.png)

도메인 모델에서 이벤트 생성주체는 엔티티, 밸류, 도메인 서비스와 같은 도메인 객체이다.

이벤트 핸들러는 이벤트 생성 주체가 발생한 이벤트에 반응한다.

이벤트 생성 주체와 이벤트 핸들러를 연결해 주는것이 이벤트 디스패처다.  
이벤트 디스패처의 구현 방식에 따라 이벤트 생성과 처리를 동기나 비동기로 실행하게 된다.

### 10.2.2 이벤트의 구성

이벤트는 발생한 이벤트에 대한 정보를 담는다.

- 이벤트 종류: 클래스 이름을 이벤트 종류를 표현
- 이벤트 발생 시간
- 추가 데이터: 주문번호, 신규 배송지 정보 등 이벤트와 관련된 정보

### 10.2.3 이벤트 용도

이벤트는 크게 2가지 용도로 쓰인다.

- 트리거
  - 도메인의 상태가 바뀔때 후처리가 필요할 경우 후처리를 실행하기 위한 트리거로 이벤트를 사용할 수 있다.
- 타 시스템간의 데이터 동기화
  - 이벤트를 사용하면 서로 다른 도메인 로직이 섞이는 것을 방지할 수 있다.

![02.png](img/02.png)

### 10.2.4 이벤트 장점

이벤트를 사용하면 서로 다른 도메인 로직이 섞이는 것을 방지할 수 있다.

![03.png](img/03.png)

이벤트 핸들러를 사용하면 기능 확장도 용이하다.  
기능을 확장해도 구매 취소 로직은 수정할 필요가 없다.

![img.png](img/04.png)

## 10.3 이벤트, 핸들러, 디스패처 구현

### 10.3.1 이벤트 클래스

### 10.3.2 Events 클래스와 ApplicationEventPublisher

### 10.3.3 이벤트 발생과 이벤트 핸들러

### 10.3.4 흐름 정리

## 10.4 동기 이벤트 처리 문제

## 10.5 비동기 이벤트 처리

### 10.5.1 로컬 핸들러 비동기 실행

### 10.5.2 메시징 시스템을 이용한 비동기 구현

### 10.5.3 이벤트 저장소를 이용한 비동기 처리

## 10.6 이벤트 적용 시 추가 고려 사항

### 10.6.1 이벤트 처리와 DB 트랜잭션 고려
